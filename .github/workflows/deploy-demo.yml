name: DÃ©ploiement sur l'espace demo

on:
  workflow_dispatch:
  push:
    branches: [main]
env:
  branch:
jobs:
  preparation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      # 47ng/actions-clever-cloud requires an unshallow working copy
      - run: git fetch --prune --unshallow
      - name: Replace crons for demo
        run: |
          CRON=$(cat << EOF
          [
            "0 0 * * * $ROOT/src/tools/jobs/stats-daily-cras.sh",
            "0 3 1 * * $ROOT/src/tools/jobs/stats-monthly-cras.sh",
            "0 6 * * * $ROOT/src/tools/jobs/stats-territoires.sh"
          ]

          EOF
          )
          echo "$CRON" > clevercloud/cron.json
      - name: Upload release api as artifact
        uses: actions/upload-artifact@v2
        with:
          name: api
          path: .

  deploy:
    needs: preparation
    runs-on: ubuntu-latest
    container:
      image: clevercloud/clever-tools
      env:
        CLEVER_TOKEN: ${{ secrets.CLEVER_TOKEN }}
        CLEVER_SECRET: ${{ secrets.CLEVER_SECRET }}
    steps:
      - name: Retrieve api
        uses: actions/download-artifact@v2
        with:
          name: api
      - name: Link the application
        run: clever link ${{ secrets.CLEVER_APP_API_DEMO_ID }}
      - name: Deploy the application
        run: clever deploy --force
      - name: Retrieve the deployment url
        run: clever domain
